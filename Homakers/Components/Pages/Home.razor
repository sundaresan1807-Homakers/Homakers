@page "/"
@using Homakers.Applications.DTOs
@using Homakers.SQLite.Models
@inject Homakers.SQLite.CustomerSQLiteInitializer _sqliteDb
@inject Homakers.Sevices.UIProfessionsServices _professionsService
@inject Homakers.Sevices.UIProfessionalService _professionalService
@inject Homakers.Sevices.UIUtilityServices _utilityServices
@inject NavigationManager _navigationManager



<h4> Welcome @(sCustomer!=null?sCustomer.Username:"")</h4>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css" integrity="sha256-3sPp8BkKUE7QyPSl6VfBByBroQbKxKG7tsusY2mhbVY=" crossorigin="anonymous" />



    <div class="container">
        @if (error != null || error == "")
        {
            <p>
                @error
            </p>
        }


        <div class="row">
            <div class="col-lg-10 mx-auto">

                <div class="career-search mb-60">
                    <!--  START Page Controls  -->
                    <form action="#" class="career-form mb-60">
                        <div class="row">
                            <div class="col-md-6 col-lg-3 my-3">
                                <div class="input-group position-relative">
                                    <input class="form-control" placeholder="Search Professional"
                                           id="keywords" @onchange="@((args) => onSearch(args))" />
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3 my-3">
                                <div class="select-container">
                                    <InputSelect id="selectDistrict" class="custom-select"
                                                 placeholder="District"
                                                 @bind-Value="selectedDistrictName"
                                                 @bind-Value:after="FilterByDistrict">
                                        <option value="" style="color:black;">Select District</option>
                                        @foreach (DistrictsDto district in districtList)
                                        {
                                            <option value="@district.DistrictName" style="color:black;">@district.DistrictName</option>
                                        }
                                    </InputSelect>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3 my-3">
                                <div class="select-container">

                                    <InputSelect id="selectProfession" class="custom-select"
                                                 @bind-Value="selectedProfessionName"
                                                 @bind-Value:after="FilterByProfession">
                                        <option value="" style="color:black;">Select Profession</option>
                                        @foreach (ProfessionsDto professionsDto in professionList)
                                        {
                                            <option value="@professionsDto.ProfessionName" style="color:black;">@professionsDto.ProfessionName</option>
                                        }
                                    </InputSelect>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3 my-3">
                                <button type="button" class="btn btn-lg btn-block btn-light btn-custom" id="contact-submit" @onclick="ClearSearch">
                                    Clear
                                </button>
                            </div>
                        </div>
                    </form>
                    <!-- END Page Controls -->
                    <!-- START Pagination -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-reset justify-content-center">
                            <li class="page-item">
                                <a class="page-link" href="#" @onclick="OnPrev" disabled="@(pageNumber <= 1 ? true : false)">
                                    Prev
                                    @*  <i class="zmdi zmdi-long-arrow-left"></i> *@
                                </a>
                            </li>
                            <p class="mb-30 ff-montserrat">Page: @pageNumber</p>
                            <li class="page-item">
                                <a class="page-link" href="#" @onclick="OnNext">
                                    Next
                                    @* <i class="zmdi zmdi-long-arrow-right"></i> *@
                                </a>
                            </li>
                        </ul>
                    </nav>
                    <!-- END Pagination -->

                    <div class="filter-result">

                        @foreach (ProfessionalProfession mappedProfessional in professionMappingList)
                        {
                            <div class="card custom-card" @onclick="() => OnBookService(mappedProfessional)">
                                <div class="card-body pd-4">
                                    <span class="card-text" style="float:left;font-size:13px;">@mappedProfessional.Name</span>
                                    <span class="card-text" style="float:right;font-size:12px;">@mappedProfessional.ProfessionName</span>
                                </div>
                                <div class="card-body pd-4">
                                    <span class="card-text" style="float:left;font-size:12px;"><i class="zmdi zmdi-money mr-2"></i> @mappedProfessional.MinPrice - @mappedProfessional.MaxPrice</span>
                                    <span class="card-text" style="float:right;font-size:12px;"><i class="zmdi zmdi-money mr-2"></i> @mappedProfessional.Mobile</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>


            </div>
        </div>

    </div>
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript"></script>
    <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"0982648f21b7499c83a555a3f57e966f","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>

@code {
    [SupplyParameterFromQuery] public string username { get; set; }
    private int pageNumber { get; set; } = 1;
    private int pageSize { get; set; } = 10;
    private SCustomers sCustomer { get; set; }
    private List<ProfessionsDto>? professionList { get; set; }
    private List<ProfessionalsDto>? professionalsList { get; set; }
    private List<ProfessionalProfession> professionMappingList { get; set; }
    private string? selectedProfessionName { get; set; }
    private string? selectedDistrictName { get; set; }
    private List<DistrictsDto>? districtList { get; set; }

    private string? searchProfessionalName { get; set; }
    private string error { get; set; }


    protected override void OnInitialized()
    {
        sCustomer = new SCustomers();
        professionList = new List<ProfessionsDto>();
        districtList = new List<DistrictsDto>();
        professionalsList = new List<ProfessionalsDto>();
        professionMappingList = new List<ProfessionalProfession>();
    }

    protected override async Task OnParametersSetAsync()
    {
        sCustomer = await _sqliteDb.GetCurrentCustomerAsync();
        if (sCustomer == null)
        {
            _navigationManager.NavigateTo("/login");
        }
        else
        {
            try
            {
                error = "";
                districtList = await _utilityServices.GetDistrictsAsync();
                professionList = await _professionsService.GetProfessionsAsync();
                professionalsList = await _professionalService.GetProfessionalsSummary(pageNumber, pageSize, null, null, null);
                MapProfessionals();
            }
            catch (Exception ex)
            {
                error = ex.Message;
            }
        }
    }

    private async Task OnPrev()
    {
        if (pageNumber > 1)
        {
            professionalsList = await _professionalService.GetProfessionalsSummary(pageNumber - 1, pageSize, selectedDistrictName, selectedProfessionName, searchProfessionalName);
            MapProfessionals();
            pageNumber--;
        }
    }

    private async Task OnNext()
    {
        professionalsList = await _professionalService.GetProfessionalsSummary(pageNumber + 1, pageSize, selectedDistrictName, selectedProfessionName, searchProfessionalName);
        MapProfessionals();
        pageNumber++;
    }

    private async Task ClearSearch()
    {
        try
        {
            selectedDistrictName = null;
            selectedProfessionName = null;
            searchProfessionalName = null;
            professionalsList = await _professionalService.GetProfessionalsSummary(pageNumber, pageSize, selectedDistrictName, selectedProfessionName, searchProfessionalName);
            MapProfessionals();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private async Task FilterByProfession()
    {
        try
        {
            if (searchProfessionalName == "")
            {
                searchProfessionalName = null;
                professionalsList = await _professionalService.GetProfessionalsSummary(pageNumber, pageSize, selectedDistrictName, selectedProfessionName, searchProfessionalName);
            }
            else
            {
                professionalsList = await _professionalService.GetProfessionalsSummary(pageNumber, pageSize, selectedDistrictName, selectedProfessionName, searchProfessionalName);
            }
            MapProfessionals();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private async Task FilterByDistrict()
    {
        try
        {
            if (selectedDistrictName == "")
            {
                selectedDistrictName = null;
                professionalsList = await _professionalService.GetProfessionalsSummary(pageNumber, pageSize, selectedDistrictName, selectedProfessionName, searchProfessionalName);
            }
            else
            {

                professionalsList = await _professionalService.GetProfessionalsSummary(pageNumber, pageSize, selectedDistrictName, selectedProfessionName, searchProfessionalName);
            }
            MapProfessionals();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private async Task onSearch(ChangeEventArgs args)
    {
        try
        {
            if (args.Value.ToString() != "")
            {
                searchProfessionalName = args.Value.ToString();
                professionalsList = await _professionalService.GetProfessionalsSummary(pageNumber, pageSize, selectedDistrictName, selectedProfessionName, searchProfessionalName);

            }
            else
            {
                searchProfessionalName = null;
                professionalsList = await _professionalService.GetProfessionalsSummary(pageNumber, pageSize, selectedDistrictName, selectedProfessionName, searchProfessionalName);
            }
            MapProfessionals();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private void MapProfessionals()
    {
        professionMappingList = new List<ProfessionalProfession>();
        foreach (ProfessionalsDto professional in professionalsList)
        {
            ProfessionalProfession mappedProfessional = new ProfessionalProfession();
            ProfessionsDto profession = professionList.Where(pro => pro.ProfessionID == professional.ProfessionID).FirstOrDefault();
            if (profession.ProfessionID == professional.ProfessionID)
            {
                mappedProfessional.ProfessionID = professional.ProfessionID;
                mappedProfessional.ProfessionalsID = professional.ProfessionalsID;
                mappedProfessional.ProfessionName = profession.ProfessionName;
                mappedProfessional.MinPrice = profession.MinPrice;
                mappedProfessional.MaxPrice = profession.MaxPrice;
                mappedProfessional.Name = professional.Name;
                mappedProfessional.Email = professional.Email;
                mappedProfessional.Mobile = professional.Mobile;
                mappedProfessional.DistrictName = professional.DistrictName;
                mappedProfessional.CustomerID = sCustomer.CustomerID;
                professionMappingList.Add(mappedProfessional);
            }
        }
    }

    private async Task OnBookService(ProfessionalProfession mappedProfessional)
    {
        _navigationManager.NavigateTo($"/bookService?Id={mappedProfessional.ProfessionalsID}&CustomerId={sCustomer.CustomerID}");
    }
}
